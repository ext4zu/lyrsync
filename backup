#!/usr/bin/env bash
# Fedora 43 (GNOME 47) Full Configuration Backup & Restore Script
# by ChatGPT x Iman

BACKUP_DIR="$HOME/fedora-gnome-backup"
DATE=$(date +%Y%m%d)
ARCHIVE="$HOME/gnome-setup-$DATE.tar.gz"

# --- FUNCTION: Dependency Check ---
check_deps() {
    echo "üîç Checking dependencies..."
    DEPS=(dconf gsettings tar gnome-extensions curl wget unzip sudo fc-cache)
    MISSING=0
    for pkg in "${DEPS[@]}"; do
        if ! command -v "$pkg" &>/dev/null; then
            echo "‚ö†Ô∏è Missing dependency: $pkg"
            MISSING=1
        fi
    done
    if [ "$MISSING" -eq 1 ]; then
        echo "‚ùå Some dependencies are missing. Install them before running this script:"
        echo "   sudo dnf install gnome-extensions-app curl wget unzip"
        exit 1
    else
        echo "‚úÖ All dependencies present."
    fi
}

# --- FUNCTION: Backup ---
backup() {
    echo "üß© Backing up GNOME 47 environment..."
    mkdir -p "$BACKUP_DIR"

    echo "‚Üí Dumping GNOME and extension settings..."
    dconf dump /org/gnome/ > "$BACKUP_DIR/dconf-gnome.conf"
    dconf dump /org/gnome/shell/extensions/ > "$BACKUP_DIR/dconf-extensions.conf"

    echo "‚Üí Saving installed extensions list..."
    gnome-extensions list > "$BACKUP_DIR/extensions-list.txt"

    echo "‚Üí Backing up user themes, icons, cursors, and fonts..."
    cp -r ~/.themes "$BACKUP_DIR/" 2>/dev/null
    cp -r ~/.icons "$BACKUP_DIR/" 2>/dev/null
    cp -r ~/.local/share/fonts "$BACKUP_DIR/fonts" 2>/dev/null

    echo "‚Üí Backing up wallpaper..."
    WALLPAPER=$(gsettings get org.gnome.desktop.background picture-uri | sed "s|'file://||;s|'||g")
    if [ -f "$WALLPAPER" ]; then
        cp "$WALLPAPER" "$BACKUP_DIR/wallpaper.png"
    fi

    echo "‚Üí Backing up system-wide themes, icons, fonts, and extensions (sudo required)..."
    sudo cp -r /usr/share/themes "$BACKUP_DIR/usr_themes" 2>/dev/null
    sudo cp -r /usr/share/icons "$BACKUP_DIR/usr_icons" 2>/dev/null
    sudo cp -r /usr/share/fonts "$BACKUP_DIR/usr_fonts" 2>/dev/null
    sudo cp -r /usr/share/gnome-shell/extensions "$BACKUP_DIR/usr_extensions" 2>/dev/null

    echo "‚Üí Backing up GDM (login screen) theme..."
    sudo cp -r /usr/share/gnome-shell/theme "$BACKUP_DIR/gdm-theme" 2>/dev/null

    echo "‚Üí Creating compressed archive..."
    tar -czf "$ARCHIVE" -C "$BACKUP_DIR" .
    echo "‚úÖ Backup complete!"
    echo "üì¶ Saved at: $ARCHIVE"
}

# --- FUNCTION: Restore ---
restore() {
    read -p "Enter path to your backup archive (.tar.gz): " ARCHIVE
    if [ ! -f "$ARCHIVE" ]; then
        echo "‚ùå File not found!"; exit 1
    fi

    echo "üß© Restoring GNOME 47 environment..."
    mkdir -p "$BACKUP_DIR"
    tar -xzf "$ARCHIVE" -C "$BACKUP_DIR"

    echo "‚Üí Restoring GNOME settings..."
    dconf load /org/gnome/ < "$BACKUP_DIR/dconf-gnome.conf" 2>/dev/null
    dconf load /org/gnome/shell/extensions/ < "$BACKUP_DIR/dconf-extensions.conf" 2>/dev/null

    echo "‚Üí Restoring user themes, icons, cursors, and fonts..."
    cp -r "$BACKUP_DIR/.themes" ~ 2>/dev/null
    cp -r "$BACKUP_DIR/.icons" ~ 2>/dev/null
    mkdir -p ~/.local/share/fonts
    cp -r "$BACKUP_DIR/fonts"/* ~/.local/share/fonts/ 2>/dev/null

    echo "‚Üí Restoring wallpaper..."
    if [ -f "$BACKUP_DIR/wallpaper.png" ]; then
        gsettings set org.gnome.desktop.background picture-uri-dark "file://$BACKUP_DIR/wallpaper.png"
        gsettings set org.gnome.desktop.background picture-uri "file://$BACKUP_DIR/wallpaper.png"
    fi

    echo "‚Üí Restoring system-wide themes, icons, fonts, and extensions (sudo required)..."
    sudo cp -r "$BACKUP_DIR/usr_themes"/* /usr/share/themes/ 2>/dev/null
    sudo cp -r "$BACKUP_DIR/usr_icons"/* /usr/share/icons/ 2>/dev/null
    sudo cp -r "$BACKUP_DIR/usr_fonts"/* /usr/share/fonts/ 2>/dev/null
    sudo cp -r "$BACKUP_DIR/usr_extensions"/* /usr/share/gnome-shell/extensions/ 2>/dev/null

    echo "‚Üí Restoring GDM (login screen) theme..."
    sudo cp -r "$BACKUP_DIR/gdm-theme"/* /usr/share/gnome-shell/theme/ 2>/dev/null

    echo "‚Üí Auto-reinstalling missing online extensions..."
    while read -r ext_uuid; do
        [ -z "$ext_uuid" ] && continue
        if ! gnome-extensions info "$ext_uuid" &>/dev/null; then
            echo "üåê Installing missing extension: $ext_uuid"
            VERSION=$(gnome-shell --version | awk '{print $3}' | cut -d'.' -f1,2)
            INFO_URL="https://extensions.gnome.org/extension-info/?uuid=$ext_uuid&shell_version=$VERSION"
            ZIP_PATH=$(curl -s "$INFO_URL" | grep -oP '(?<=\"download_url\": \")[^\"]*')
            if [ -n "$ZIP_PATH" ]; then
                wget -qO /tmp/ext.zip "https://extensions.gnome.org$ZIP_PATH"
                unzip -oq /tmp/ext.zip -d ~/.local/share/gnome-shell/extensions/"$ext_uuid"
                echo "‚úÖ Extension $ext_uuid installed."
            else
                echo "‚ö†Ô∏è Could not find download URL for $ext_uuid"
            fi
        fi
        gnome-extensions enable "$ext_uuid" 2>/dev/null
    done < "$BACKUP_DIR/extensions-list.txt"

    echo "‚Üí Rebuilding font cache and refreshing GNOME shell..."
    fc-cache -rv > /dev/null
    sudo update-desktop-database > /dev/null 2>&1
    echo "‚úÖ Restore complete! Log out or press Alt+F2 ‚Üí type 'r' ‚Üí Enter to reload GNOME."
}

# --- FUNCTION: Verify Backup ---
verify() {
    echo "üîç Verifying backup integrity..."
    read -p "Enter path to your backup archive (.tar.gz): " ARCHIVE
    if [ ! -f "$ARCHIVE" ]; then
        echo "‚ùå File not found!"; exit 1
    fi

    REQUIRED=(dconf-gnome.conf extensions-list.txt wallpaper.png)
    tar -tzf "$ARCHIVE" > /tmp/backup_contents.txt

    for file in "${REQUIRED[@]}"; do
        if grep -q "$file" /tmp/backup_contents.txt; then
            echo "‚úÖ Found: $file"
        else
            echo "‚ö†Ô∏è Missing: $file"
        fi
    done
    echo "üß† Verification complete."
}

# --- MAIN ENTRY ---
case "$1" in
    backup)
        check_deps
        backup ;;
    restore)
        check_deps
        restore ;;
    verify)
        verify ;;
    *)
        echo "Usage: $0 [backup|restore|verify]"
        exit 1 ;;
esac